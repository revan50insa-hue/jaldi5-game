<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jaldi 5 Multiplayer</title>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
body{margin:0;font-family:Arial,sans-serif;background:linear-gradient(135deg,#1a1a2e,#16213e);color:white;height:100vh;}
.header{text-align:center;padding:20px;font-size:28px;font-weight:bold;background:#0f3460;}
.container{display:flex;flex-direction:column;align-items:center;margin-top:30px;}
.card{width:85%;background:#222831;border-radius:15px;padding:20px;margin:15px;box-shadow:0 10px 20px rgba(0,0,0,0.5);}
.card h2{margin-top:0;}
input{width:90%;padding:12px;margin-top:10px;border-radius:8px;border:none;font-size:16px;}
button{margin-top:15px;padding:12px 25px;border:none;border-radius:8px;background:#00adb5;color:white;font-size:16px;cursor:pointer;}
button:hover{background:#028a90;}
.hidden{display:none;}
.lobby{text-align:center;padding:20px;}
.ticket{display:inline-block;margin:10px;background:#fff;color:#000;border-radius:5px;padding:5px;}
.ticket table{border-collapse:collapse;}
.ticket td{width:30px;height:30px;text-align:center;border:1px solid #333;}
.ticket td.blank{background:#eee;}
.ticket td.marked{background:#00ff00;color:#000;font-weight:bold;}
#showNumberBtn{margin-top:20px;background:#f44336;}
#currentNumber{margin-top:20px;font-size:20px;font-weight:bold;}
#lineNotifications{margin-top:20px;}
</style>
</head>
<body>

<!-- HOME PAGE -->
<div id="homePage">
<div class='header'>ðŸŽ¯ JALDI 5</div>
<div class='container'>

<div class='card'>
<h2>Create Group</h2>
<p>Create a new game and invite friends</p>
<button onclick='createGroup()'>Create Group</button>
</div>

<div class='card'>
<h2>Join Group</h2>
<p>Enter Group ID to join</p>
<input id='groupInput' placeholder='Enter Group ID'>
<button onclick='joinGroup()'>Join Group</button>
</div>

</div>
</div>

<!-- LOBBY PAGE -->
<div id='lobbyPage' class='hidden'>
<div class='header'>ðŸŽ® Game Lobby</div>
<div class='lobby'>
<h2>Group ID: <span id='groupIdText'></span></h2>

<!-- Change Name (Always visible in lobby) -->
<div id="nameDiv">
<input id="nameInput" placeholder="Enter your name">
<button onclick="updateName()">Set Name</button>
</div>

<div id='playerList'></div>
<div id='startGameDiv' class='hidden'>
<button id='startGameBtn' onclick='startGame()'>Start Game</button>
</div>
</div>
</div>

<!-- GAME PAGE -->
<div id='gamePage' class='hidden'>
<div class='header'>ðŸŽ¯ Jaldi 5</div>
<div class='lobby'>
<h3>Group ID: <span id='gameGroupId'></span></h3>
<div id='myTicketContainer'></div>
<button id='showNumberBtn' class='hidden' onclick='showNextNumber()'>Show Number</button>
<div id='currentNumber'></div>
<div id="lineNotifications"></div>
</div>
</div>

<script>
// ---------- Firebase ----------
var firebaseConfig = {
  apiKey: "AIzaSyCeg-D---KoJEtVcBN5iwFs9WDHBRIgZjA",
  authDomain: "tffhacksv4.firebaseapp.com",
  databaseURL: "https://tffhacksv4-default-rtdb.firebaseio.com",
  projectId: "tffhacksv4",
  storageBucket: "tffhacksv4.firebasestorage.app",
  messagingSenderId: "641197191429",
  appId: "1:641197191429:web:7b63ca534dd41e19d8476c"
};
firebase.initializeApp(firebaseConfig);
var db = firebase.database();

// ---------- Player ----------
var playerId = 'PLR_'+Math.floor(Math.random()*1000000);
var currentGroupId = '';
var isCreator = false;
var gameNumbers = [];
var currentIndex = 0;
var myTicket = [];
var drawnNumbers = [];

// ---------- Create Group ----------
function createGroup(){
  var groupId = 'GRP-'+Math.floor(100000 + Math.random()*900000);
  isCreator = true;
  currentGroupId = groupId;

  db.ref('groups/'+groupId).set({
    creator: playerId,
    players:{},
    gameStarted:false,
    linesClaimed:{} // <-- NEW: to track first line completion
  }, function(error){
    if(!error){
      joinFirebaseGroup(groupId);
    } else {
      alert("Failed to create group!");
    }
  });
}

// ---------- Join Group ----------
function joinGroup(){
  var groupId = document.getElementById('groupInput').value.trim();
  if(groupId===''){ alert("Enter Group ID"); return; }
  isCreator = false;
  currentGroupId = groupId;
  joinFirebaseGroup(groupId);
}

// ---------- Update Name ----------
function updateName(){
  var name = document.getElementById('nameInput').value.trim();
  if(name===''){ alert("Enter a name"); return; }
  db.ref('groups/'+currentGroupId+'/players/'+playerId+'/name').set(name);
}

// ---------- Join Firebase Group ----------
function joinFirebaseGroup(groupId){
  currentGroupId = groupId;
  document.getElementById('homePage').classList.add('hidden');
  document.getElementById('lobbyPage').classList.remove('hidden');
  document.getElementById('groupIdText').innerText = groupId;

  db.ref('groups/'+groupId+'/players/'+playerId).set({name:playerId});

  // Update player list
  db.ref('groups/'+groupId+'/players').on('value', snapshot=>{
    var players = snapshot.val()||{};
    var html = "<h3>Players ("+Object.keys(players).length+"):</h3><ul>";
    for(var p in players){ html+="<li>"+(players[p].name||p)+"</li>"; }
    html+="</ul>";
    document.getElementById('playerList').innerHTML = html;
    if(isCreator){ document.getElementById('startGameDiv').classList.remove('hidden'); }
  });

  // Listen group changes
  db.ref('groups/'+groupId).on('value', snapshot=>{
    var data = snapshot.val();
    if(!data) return;

    if(data.tickets && data.tickets[playerId]){
      myTicket = data.tickets[playerId];
      displayMyTicket();
    }

    if(data.gameStarted){
      document.getElementById('lobbyPage').classList.add('hidden');
      document.getElementById('gamePage').classList.remove('hidden');
      document.getElementById('gameGroupId').innerText = currentGroupId;
      if(isCreator) document.getElementById('showNumberBtn').classList.remove('hidden');
    }

    if(data.currentNumber) highlightNumber(data.currentNumber);

    // Display line completion notifications for first player only
    if(data.linesClaimed){
      var html = "<h3>Line Completed:</h3><ul>";
      for(var line in data.linesClaimed){
        if(data.linesClaimed[line]){
          var pname = (data.players && data.players[data.linesClaimed[line]] && data.players[data.linesClaimed[line]].name) || data.linesClaimed[line];
          html += "<li>"+pname+" completed "+line+" line</li>";
        }
      }
      html+="</ul>";
      document.getElementById('lineNotifications').innerHTML = html;
    }
  });
}

// ---------- Start Game ----------
function startGame(){
  gameNumbers = shuffleArray([...Array(90).keys()].map(x=>x+1));
  currentIndex = 0;

  db.ref('groups/'+currentGroupId+'/players').once('value', snapshot=>{
    var players = snapshot.val();
    var tickets = {};
    for(var p in players){
      tickets[p] = generateTicket();
    }
    db.ref('groups/'+currentGroupId).update({
      tickets: tickets,
      gameStarted: true
    });
  });
}

// ---------- Display My Ticket ----------
function displayMyTicket(){
  if(!myTicket) return;
  var html="<div class='ticket'><b>My Ticket</b><br><table id='myTicketTable'>";
  for(var r=0;r<3;r++){
    html+="<tr>";
    for(var c=0;c<9;c++){
      var val = myTicket[r][c];
      if(val==null){ html+="<td class='blank'></td>"; }
      else{ html+="<td id='cell-"+r+"-"+c+"' data-number='"+val+"'>"+val+"</td>"; }
    }
    html+="</tr>";
  }
  html+="</table></div>";
  document.getElementById('myTicketContainer').innerHTML = html;

  drawnNumbers.forEach(n => highlightNumber(n));
}

// ---------- Show Next Number ----------
function showNextNumber(){
  if(currentIndex>=gameNumbers.length) return alert("All numbers drawn!");
  var num = gameNumbers[currentIndex++];
  db.ref('groups/'+currentGroupId+'/currentNumber').set(num);
}

// ---------- Highlight Number ----------
function highlightNumber(num){
  if(drawnNumbers.indexOf(num) === -1){
    drawnNumbers.push(num);
  }

  var table = document.getElementById('myTicketTable');
  if(!table) return;

  drawnNumbers.forEach(n => {
    var cells = table.querySelectorAll('td[data-number="'+n+'"]');
    cells.forEach(cell => cell.classList.add('marked'));
  });

  document.getElementById('currentNumber').innerText = "Number: "+num;

  checkLineCompletion();
}

// ---------- Check Line Completion ----------
function checkLineCompletion(){
  if(!myTicket || !currentGroupId) return;

  var lines = ["Top","Middle","Bottom"];
  var completed = [];

  for(var r=0;r<3;r++){
    var lineNumbers = myTicket[r].filter(n => n!==null);
    var markedNumbers = lineNumbers.filter(n => drawnNumbers.includes(n));
    if(lineNumbers.length>0 && markedNumbers.length === lineNumbers.length){
      completed.push(lines[r]);
    }
  }

  if(completed.length>0){
    completed.forEach(line=>{
      var ref = db.ref('groups/'+currentGroupId+'/linesClaimed/'+line);
      ref.once('value', snap=>{
        if(!snap.val()){ // if line not yet claimed
          ref.set(playerId);
        }
      });
    });
  }
}

// ---------- Utilities ----------
function shuffleArray(array){
  for(let i=array.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [array[i],array[j]]=[array[j],array[i]];
  }
  return array;
}

function generateTicket(){
  var ticket = [];
  for(var r=0;r<3;r++){
    ticket[r]=Array(9).fill(null);
  }
  var numbers = shuffleArray([...Array(90).keys()].map(x=>x+1));
  var used = 0;
  for(var r=0;r<3;r++){
    var cols = shuffleArray([0,1,2,3,4,5,6,7,8]).slice(0,5);
    for(var c of cols){
      ticket[r][c]=numbers[used++];
    }
  }
  return ticket;
}
</script>
</body>
</html>
